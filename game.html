<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coco Clan Pro - Survival & Conquest</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap');
        body { margin: 0; background: #1a1a1a; overflow: hidden; font-family: 'Poppins', sans-serif; color: white; user-select: none; }
        canvas { display: block; background: radial-gradient(circle, #3d7a36 0%, #244d20 100%); cursor: crosshair; }
        
        #ui-layer { position: fixed; top: 0; left: 0; width: 100%; pointer-events: none; z-index: 10; }
        .top-bar { display: flex; justify-content: space-around; background: linear-gradient(to bottom, rgba(0,0,0,0.9), rgba(0,0,0,0.7)); padding: 12px; pointer-events: all; border-bottom: 3px solid #f1c40f; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .resource { font-weight: bold; color: #f1c40f; font-size: 15px; display: flex; align-items: center; gap: 5px; }
        
        .action-menu { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); 
                      display: flex; gap: 12px; background: rgba(10,10,10,0.95); padding: 15px; 
                      border-radius: 30px; border: 2px solid #f1c40f; pointer-events: all; box-shadow: 0 -5px 25px rgba(0,0,0,0.8); }
        
        .menu-item { text-align: center; cursor: pointer; transition: 0.2s; padding: 10px; border-radius: 20px; width: 75px; background: #222; border: 1px solid #444; }
        .menu-item:hover { transform: translateY(-5px); border-color: #f1c40f; background: #333; }
        .menu-item img { width: 40px; height: 40px; filter: drop-shadow(0 0 5px rgba(241, 196, 15, 0.5)); }
        .menu-item span { display: block; font-size: 10px; margin-top: 5px; font-weight: bold; color: #eee; }

        .btn-active { background: #f1c40f !important; color: #000 !important; box-shadow: 0 0 15px #f1c40f; }
        .btn-active span { color: #000 !important; }

        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); 
                    flex-direction: column; justify-content: center; align-items: center; z-index: 100; text-align: center; }
        #overlay h2 { font-size: 60px; color: #f1c40f; margin: 0; text-shadow: 0 0 20px #f1c40f; }
    </style>
</head>
<body>

<div id="overlay">
    <h2>VICTORY!</h2>
    <p style="font-size: 20px;">Enemy Base has been Purged.</p>
    <button onclick="resetGame()" style="padding: 15px 40px; cursor: pointer; background: #f1c40f; border: none; border-radius: 10px; font-weight: bold; font-size: 18px; transition: 0.3s;">NEXT MISSION</button>
</div>

<div id="ui-layer">
    <div class="top-bar">
        <div class="resource">ü•• <span id="res-coco">0</span></div>
        <div class="resource">‚öîÔ∏è <span id="res-troops">0</span></div>
        <div class="resource">üö© <span id="res-enemy">0</span></div>
        <button onclick="saveGame()" style="pointer-events:all; background:#222; color:#f1c40f; border:1px solid #f1c40f; padding:5px 10px; border-radius:5px; font-size:10px; cursor:pointer;">SAVE</button>
    </div>
</div>

<div class="action-menu">
    <div class="menu-item" id="btn-mine" onclick="setMode('build', 'mine', 150)">
        <img src="https://cdn-icons-png.flaticon.com/512/1239/1239608.png" alt="Mine">
        <span>Mine (150)</span>
    </div>
    <div class="menu-item" id="btn-barracks" onclick="setMode('build', 'barracks', 300)">
        <img src="https://cdn-icons-png.flaticon.com/512/619/619153.png" alt="Barracks">
        <span>Barracks (300)</span>
    </div>
    <div class="menu-item" onclick="trainTroop(100)">
        <img src="https://cdn-icons-png.flaticon.com/512/3534/3534069.png" alt="Train">
        <span>Train (100)</span>
    </div>
    <div class="menu-item" id="btn-deploy" onclick="setMode('attack', 'soldier', 0)">
        <img src="https://cdn-icons-png.flaticon.com/512/2563/2563030.png" alt="Attack">
        <span>Deploy</span>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Audio Context for Sounds
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(freq, type, duration) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    }

    let resources = { coco: 1000, troops: 0 };
    let buildings = [];
    let troops = [];
    let currentMode = null;
    let selectedSubtype = null;
    let selectedCost = 0;

    // Load Data from Storage
    function loadGame() {
        const saved = localStorage.getItem('cocoClanSave');
        if (saved) {
            const data = JSON.parse(saved);
            resources = data.resources;
            buildings = data.buildings.map(b => new Building(b.x, b.y, b.type, b.isEnemy));
            if (buildings.filter(b => b.isEnemy).length === 0) initEnemy();
        } else { initEnemy(); }
    }

    function saveGame() {
        localStorage.setItem('cocoClanSave', JSON.stringify({ resources, buildings }));
        playSound(800, 'sine', 0.1);
    }

    function resetGame() { localStorage.removeItem('cocoClanSave'); location.reload(); }

    class Building {
        constructor(x, y, type, isEnemy = false) {
            this.x = x; this.y = y; this.type = type; this.isEnemy = isEnemy;
            this.size = 60; this.hp = isEnemy ? 250 : 120; this.maxHp = this.hp;
        }
        draw() {
            ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.beginPath(); ctx.ellipse(this.x, this.y + 30, 40, 15, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#333"; ctx.fillRect(this.x - 32, this.y - 47, 64, 8);
            ctx.fillStyle = this.isEnemy ? "#ff4757" : "#2ed573"; ctx.fillRect(this.x - 30, this.y - 45, (this.hp/this.maxHp)*60, 4);
            ctx.fillStyle = this.isEnemy ? '#b71c1c' : (this.type === 'mine' ? '#f1c40f' : '#1976d2');
            ctx.fillRect(this.x - 30, this.y - 30, 60, 60);
            ctx.strokeStyle = "rgba(255,255,255,0.2)"; ctx.strokeRect(this.x - 30, this.y - 30, 60, 60);
            ctx.fillStyle = "#fff"; ctx.font = "bold 9px Poppins"; ctx.textAlign = "center";
            ctx.fillText(this.isEnemy ? "TARGET" : this.type.toUpperCase(), this.x, this.y + 5);
        }
    }

    class Troop {
        constructor(x, y) {
            this.x = x; this.y = y; this.speed = 1.3; this.target = null;
        }
        update() {
            let enemies = buildings.filter(b => b.isEnemy);
            if (enemies.length > 0) {
                this.target = enemies[0];
                let minDist = Math.hypot(this.x - this.target.x, this.y - this.target.y);
                enemies.forEach(b => {
                    let d = Math.hypot(this.x - b.x, this.y - b.y);
                    if (d < minDist) { minDist = d; this.target = b; }
                });
                if (minDist > 45) {
                    let angle = Math.atan2(this.target.y - this.y, this.target.x - this.x);
                    this.x += Math.cos(angle) * this.speed; this.y += Math.sin(angle) * this.speed;
                } else {
                    this.target.hp -= 0.6;
                    if (Math.random() > 0.95) playSound(150, 'square', 0.05); // Attack Sound
                }
            }
        }
        draw() {
            ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(this.x, this.y, 8, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#f1c40f"; ctx.beginPath(); ctx.arc(this.x, this.y, 5, 0, Math.PI*2); ctx.fill();
        }
    }

    function initEnemy() {
        const w = canvas.width; const h = canvas.height;
        buildings.push(new Building(w - 120, h/2, 'hq', true));
        buildings.push(new Building(w - 200, h/2 - 100, 'tower', true));
        buildings.push(new Building(w - 200, h/2 + 100, 'tower', true));
    }

    function setMode(mode, subtype, cost) {
        currentMode = mode; selectedSubtype = subtype; selectedCost = cost;
        document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('btn-active'));
        if (mode === 'build') document.getElementById('btn-' + subtype).classList.add('btn-active');
        if (mode === 'attack') document.getElementById('btn-deploy').classList.add('btn-active');
    }

    function trainTroop(cost) {
        if (resources.coco >= cost) {
            resources.coco -= cost; resources.troops++;
            playSound(400, 'triangle', 0.2);
        }
    }

    canvas.addEventListener('click', (e) => {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        if (currentMode === 'build' && resources.coco >= selectedCost) {
            buildings.push(new Building(e.clientX, e.clientY, selectedSubtype, false));
            resources.coco -= selectedCost; playSound(300, 'sine', 0.3);
        } else if (currentMode === 'attack' && resources.troops > 0) {
            troops.push(new Troop(e.clientX, e.clientY));
            resources.troops--; playSound(600, 'sine', 0.1);
        }
    });

    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        let enemyCount = 0;
        buildings = buildings.filter(b => {
            if (b.hp <= 0) {
                if (b.isEnemy) playSound(100, 'sawtooth', 0.5);
                return false;
            }
            return true;
        });

        buildings.forEach(b => {
            b.draw();
            if (!b.isEnemy && b.type === 'mine') resources.coco += 0.1;
            if (b.isEnemy) enemyCount++;
        });

        if (enemyCount === 0 && buildings.length > 0) document.getElementById('overlay').style.display = "flex";

        troops.forEach(t => { t.update(); t.draw(); });
        
        document.getElementById('res-coco').innerText = Math.floor(resources.coco);
        document.getElementById('res-troops').innerText = resources.troops;
        document.getElementById('res-enemy').innerText = enemyCount;
        
        requestAnimationFrame(gameLoop);
    }

    loadGame();
    setInterval(saveGame, 5000); // Auto-save every 5s
    gameLoop();
</script>
</body>
</html>
