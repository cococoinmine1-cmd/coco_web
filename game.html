<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coco Clan - Ultimate Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap');
        body { margin: 0; background: #1a1a1a; overflow: hidden; font-family: 'Poppins', sans-serif; user-select: none; }
        canvas { display: block; background: radial-gradient(circle, #4caf50 0%, #2e7d32 100%); cursor: grab; }

        /* Login Screen */
        #login-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; color: white; }
        #login-screen input { padding: 15px; border-radius: 12px; border: 2px solid #f1c40f; width: 260px; margin: 20px; font-size: 18px; text-align: center; background: #222; color: #fff; }
        #login-screen button { padding: 15px 40px; background: #f1c40f; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 18px; box-shadow: 0 5px 0 #b7950b; }

        /* UI Styling */
        .top-ui { position: fixed; top: 15px; right: 15px; display: flex; flex-direction: column; gap: 8px; z-index: 100; pointer-events: none; }
        .res-box { background: rgba(0,0,0,0.8); border: 2px solid #f1c40f; border-radius: 12px; padding: 6px 15px; color: #fff; font-weight: bold; width: 130px; display: flex; justify-content: space-between; pointer-events: all; }
        .res-box span { font-size: 10px; color: #f1c40f; }

        .lvl-box { position: fixed; top: 15px; left: 15px; width: 55px; height: 55px; background: #2980b9; border: 3px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 22px; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .commander-label { position: fixed; top: 25px; left: 80px; color: #fff; font-weight: bold; text-shadow: 2px 2px #000; z-index: 100; }

        .bottom-ui { position: fixed; bottom: 25px; width: 100%; display: flex; justify-content: center; gap: 15px; z-index: 100; pointer-events: none; }
        .btn { width: 80px; height: 80px; background: #e67e22; border: 3px solid #fff; border-radius: 20px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: bold; box-shadow: 0 6px 0 #d35400; pointer-events: all; }
        .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #d35400; }
        
        #alert-box { position: fixed; top: 100px; width: 100%; text-align: center; color: #ff4757; font-size: 24px; font-weight: bold; text-shadow: 2px 2px #000; pointer-events: none; opacity: 0; transition: 0.5s; z-index: 100; }
    </style>
</head>
<body>

<div id="login-screen">
    <h1 style="color: #f1c40f; font-size: 40px;">COCO CLAN</h1>
    <p>ENTER COMMANDER NAME</p>
    <input type="text" id="p-name" placeholder="Name..." maxlength="10">
    <button onclick="startGame()">START GAME</button>
</div>

<div id="alert-box">‚ö†Ô∏è ENEMY RAIDING! ‚ö†Ô∏è</div>
<div class="lvl-box" id="p-lvl">1</div>
<div class="commander-label" id="p-display-name">COMMANDER</div>

<div class="top-ui">
    <div class="res-box"><span>ü•• COCO</span> <div id="ui-coco">500</div></div>
    <div class="res-box"><span>ü™µ WOOD</span> <div id="ui-wood">100</div></div>
</div>

<div class="bottom-ui">
    <div class="btn" onclick="prepareBuild('house', 200, 50)"><img src="https://cdn-icons-png.flaticon.com/512/619/619153.png" width="30">HOUSE</div>
    <div class="btn" style="background:#7f8c8d" onclick="prepareBuild('wall', 50, 20)"><img src="https://cdn-icons-png.flaticon.com/512/3534/3534123.png" width="30">WALL</div>
    <div class="btn" style="background:#2c3e50" onclick="prepareBuild('cannon', 450, 120)"><img src="https://cdn-icons-png.flaticon.com/512/1063/1063181.png" width="30">CANNON</div>
    <div class="btn" style="background:#f1c40f; color:#000" onclick="saveGame()">SAVE</div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let res = { coco: 500, wood: 100, name: "Commander", lvl: 1 };
    let buildings = [], enemies = [], bullets = [], trees = [];
    let offsetX = canvas.width / 2, offsetY = canvas.height / 4;
    let isDragging = false, lastX, lastY, currentPlacing = null;

    // Load initial nature
    for(let i=0; i<12; i++) trees.push({ x: Math.random()*600-300, y: Math.random()*600-300, hp: 5 });

    function startGame() {
        const nameInput = document.getElementById('p-name').value;
        if(nameInput) {
            res.name = nameInput;
            document.getElementById('p-display-name').innerText = "CO: " + res.name;
            document.getElementById('login-screen').style.display = "none";
            loadGame();
            spawnEnemyLoop();
        }
    }

    function toIso(x, y) { return { ix: (x - y) + offsetX, iy: (x + y) / 2 + offsetY }; }

    function prepareBuild(type, c, w) {
        if(res.coco >= c && res.wood >= w) {
            currentPlacing = { type, x: 0, y: 0, hp: 100, maxHp: 100, c, w };
        } else { alert("Not enough resources!"); }
    }

    canvas.addEventListener('mousedown', e => { isDragging = true; lastX = e.clientX; lastY = e.clientY; });
    canvas.addEventListener('mousemove', e => {
        if (isDragging) { offsetX += e.clientX - lastX; offsetY += e.clientY - lastY; lastX = e.clientX; lastY = e.clientY; }
        if (currentPlacing) {
            let mx = e.clientX - offsetX, my = (e.clientY - offsetY) * 2;
            currentPlacing.x = Math.round(((my+mx)/2)/40)*40;
            currentPlacing.y = Math.round(((my-mx)/2)/40)*40;
        }
    });

    window.addEventListener('mouseup', e => {
        if (currentPlacing) {
            res.coco -= currentPlacing.c; res.wood -= currentPlacing.w;
            buildings.push({...currentPlacing}); currentPlacing = null;
        }
        isDragging = false;
    });

    function spawnEnemyLoop() {
        setInterval(() => {
            enemies.push({ x: 400, y: (Math.random()*400-200), hp: 50 });
            document.getElementById('alert-box').style.opacity = 1;
            setTimeout(() => document.getElementById('alert-box').style.opacity = 0, 2000);
        }, 15000);
    }

    function drawWorld() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        
        // Grid
        for(let i=-400; i<=400; i+=80) {
            for(let j=-400; j<=400; j+=80) {
                let p = toIso(i, j); ctx.strokeStyle = "rgba(0,0,0,0.1)"; ctx.strokeRect(p.ix-40, p.iy, 80, 40);
            }
        }

        // Trees
        trees.forEach(t => {
            let p = toIso(t.x, t.y);
            ctx.fillStyle = "#1b3310"; ctx.beginPath(); ctx.arc(p.ix, p.iy-10, 10, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#5d4037"; ctx.fillRect(p.ix-2, p.iy, 4, 8);
        });

        // Buildings
        buildings.forEach((b, idx) => {
            let p = toIso(b.x, b.y);
            ctx.fillStyle = b.type === 'house' ? '#a52a2a' : (b.type === 'wall' ? '#7f8c8d' : '#2c3e50');
            ctx.beginPath(); ctx.moveTo(p.ix, p.iy-25); ctx.lineTo(p.ix+35, p.iy); ctx.lineTo(p.ix, p.iy+25); ctx.lineTo(p.ix-35, p.iy); ctx.fill();
            
            if(b.type === 'cannon') {
                enemies.forEach(en => {
                    if(Math.hypot(b.x-en.x, b.y-en.y) < 250 && Math.random() > 0.97) {
                        bullets.push({ x: b.x, y: b.y, tx: en.x, ty: en.y });
                        en.hp -= 5;
                    }
                });
            }
        });

        // Enemies & Bullets
        enemies.forEach((en, i) => {
            en.x -= 0.5; let p = toIso(en.x, en.y);
            ctx.fillStyle = "#ff4757"; ctx.beginPath(); ctx.arc(p.ix, p.iy, 8, 0, Math.PI*2); ctx.fill();
            if(en.hp <= 0) { enemies.splice(i, 1); res.coco += 50; }
        });

        bullets.forEach((bl, i) => {
            bl.x += (bl.tx - bl.x) * 0.1; bl.y += (bl.ty - bl.y) * 0.1;
            let p = toIso(bl.x, bl.y);
            ctx.fillStyle = "#f1c40f"; ctx.beginPath(); ctx.arc(p.ix, p.iy, 4, 0, Math.PI*2); ctx.fill();
            if(Math.hypot(bl.x-bl.tx, bl.y-bl.ty) < 5) bullets.splice(i,1);
        });

        if(currentPlacing) {
            let p = toIso(currentPlacing.x, currentPlacing.y);
            ctx.globalAlpha = 0.4; ctx.fillStyle = "#fff";
            ctx.beginPath(); ctx.moveTo(p.ix, p.iy-25); ctx.lineTo(p.ix+35, p.iy); ctx.lineTo(p.ix, p.iy+25); ctx.lineTo(p.ix-35, p.iy); ctx.fill(); ctx.globalAlpha = 1;
        }
    }

    function saveGame() {
        localStorage.setItem('cocoClanMasterSave', JSON.stringify({ res, buildings }));
        alert("Kingdom Saved Successfully!");
    }

    function loadGame() {
        const saved = localStorage.getItem('cocoClanMasterSave');
        if(saved) {
            const data = JSON.parse(saved);
            res = data.res; buildings = data.buildings;
            document.getElementById('p-display-name').innerText = "CO: " + res.name;
        }
    }

    function loop() {
        drawWorld();
        document.getElementById('ui-coco').innerText = Math.floor(res.coco);
        document.getElementById('ui-wood').innerText = Math.floor(res.wood);
        document.getElementById('p-lvl').innerText = res.lvl;
        requestAnimationFrame(loop);
    }
    loop();
</script>
</body>
</html>
